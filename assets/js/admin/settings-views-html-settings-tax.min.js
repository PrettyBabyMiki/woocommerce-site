!function(a,b,c){a(function(){String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")});var d=c.template("wc-tax-table-row"),e=c.template("wc-tax-table-row-empty"),f=c.template("wc-tax-table-pagination"),g=a(".wc_tax_rates"),h=a("#rates"),i=a("#unsaved-changes"),j=a("#rates-pagination"),k=a("#rates-search .wc-tax-rates-search-field"),l=Backbone.Model.extend({changes:{},setRateAttribute:function(a,b,c){var d=_.indexBy(this.get("rates"),"tax_rate_id"),e={};d[a][b]!==c&&(e[a]={},e[a][b]=c,d[a][b]=c),this.logChanges(e)},logChanges:function(a){var b=this.changes||{};_.each(a,function(a,c){b[c]=_.extend(b[c]||{tax_rate_id:c},a)}),this.changes=b,this.trigger("change:rates")},getFilteredRates:function(){var a=this.get("rates"),b=k.val().toLowerCase();return b.length&&(a=_.filter(a,function(a){var c=_.toArray(a).join(" ").toLowerCase();return-1!==c.indexOf(b)})),a=_.sortBy(a,function(a){return parseInt(a.tax_rate_order,10)})}}),m=Backbone.View.extend({rowTemplate:d,per_page:b.limit,page:b.page,initialize:function(){this.qty_pages=Math.ceil(_.toArray(this.model.get("rates")).length/this.per_page),this.page=this.sanitizePage(b.page),this.listenTo(this.model,"change:rates",this.setUnloadConfirmation),h.on("change",{view:this},this.updateModelOnChange),h.on("sortupdate",{view:this},this.updateModelOnSort),k.on("keyup search",{view:this},this.onSearchField),j.on("click","a",{view:this},this.onPageChange),j.on("change","input",{view:this},this.onPageChange),a(window).on("beforeunload",{view:this},this.unloadConfirmation),g.find(".insert").on("click",{view:this},this.onAddNewRow),g.find(".remove_tax_rates").on("click",{view:this},this.onDeleteRow)},render:function(){var c=this.model.getFilteredRates(),d=_.size(c),g=Math.ceil(d/this.per_page),i=this.per_page*(this.page-1),l=this.per_page*this.page,m=_.toArray(c).slice(i,l),n=this;this.$el.empty(),m.length?a.each(m,function(a,b){n.$el.append(n.rowTemplate(b))}):n.$el.append(e()),this.$el.find("td.country input").autocomplete({source:b.countries,minLength:2}),this.$el.find("td.state input").autocomplete({source:b.states,minLength:3}),this.$el.find("td.postcode input, td.city input").change(function(){a(this).attr("name",a(this).data("name"))}),g>1&&j.html(f({qty_rates:d,current_page:this.page,qty_pages:g})),k.val()?h.sortable("disable"):h.sortable("enable")},updateUrl:function(){if(window.history.replaceState){var a=b.base_url,c=k.val();1<this.page&&(a+="&p="+encodeURIComponent(this.page)),c.length&&(a+="&s="+encodeURIComponent(c)),window.history.replaceState({},"",a)}},onAddNewRow:function(a){var c,d,e,f,g,i=a.data.view,j=i.model,k=_.indexBy(j.get("rates"),"tax_rate_id"),l={},m=_.size(k),n=_.extend({},b.default_rate,{tax_rate_id:"new-"+m+"-"+Date.now(),newRow:!0});a.preventDefault(),(c=h.children(".current"))?(d=c.last().data("id"),e=parseInt(k[d].tax_rate_order,10),n.tax_rate_order=1+e,f=_.filter(k,function(a){return parseInt(a.tax_rate_order,10)>e?!0:!1}),g=_.map(f,function(a){return a.tax_rate_order++,l[a.tax_rate_id]=_.extend(l[a.tax_rate_id]||{},{tax_rate_order:a.tax_rate_order}),a})):n.tax_rate_order=1+_.max(_.pluck(k,"tax_rate_order"),function(a){return parseInt(a,10)}),k[n.tax_rate_id]=n,l[n.tax_rate_id]=n,j.set("rates",k),j.logChanges(l),i.render()},onDeleteRow:function(c){var d,e,f,g,i,j=c.data.view,k=j.model,l=_.indexBy(k.get("rates"),"tax_rate_id"),m={};c.preventDefault(),(d=h.children(".current"))?(d.each(function(){e=a(this).data("id"),f=parseInt(l[e].tax_rate_order,10),g=_.filter(l,function(a){return parseInt(a.tax_rate_order,10)>f?!0:!1}),i=_.map(g,function(a){return a.tax_rate_order--,m[a.tax_rate_id]=_.extend(m[a.tax_rate_id]||{},{tax_rate_order:a.tax_rate_order}),a}),delete l[e],m[e]=_.extend(m[e]||{},{deleted:"deleted"})}),k.set("rates",l),k.logChanges(m),j.render()):window.alert(b.strings.no_rows_selected)},onSearchField:function(a){a.data.view.updateUrl(),a.data.view.render()},onPageChange:function(b){var c=a(b.currentTarget);b.preventDefault(),b.data.view.page=c.data("goto")?c.data("goto"):c.val(),b.data.view.render(),b.data.view.updateUrl()},setUnloadConfirmation:function(){this.needsUnloadConfirm=!0,i.show(),i.find("pre").text(JSON.stringify(this.model.changes,null,"	"))},clearUnloadConfirmation:function(){this.needsUnloadConfirm=!1,i.hide()},unloadConfirmation:function(a){return a.data.view.needsUnloadConfirm?(a.returnValue=b.strings.unload_confirmation_msg,window.event.returnValue=b.strings.unload_confirmation_msg,b.strings.unload_confirmation_msg):void 0},updateModelOnChange:function(b){var c=b.data.view.model,d=a(b.target),e=d.closest("tr").data("id"),f=d.data("attribute"),g=d.val();("city"===f||"postcode"===f)&&(g=g.split(";"),g=a.map(g,function(a){return a.trim()})),("tax_rate_compound"===f||"tax_rate_shipping"===f)&&(g=d.is(":checked")?1:0),c.setRateAttribute(e,f,g)},updateModelOnSort:function(a,b){var c,d,e=a.data.view,f=e.model,g=b.item,h=g.data("id"),i=_.indexBy(f.get("rates"),"tax_rate_id"),j=i[h].tax_rate_order,k=g.index()+(e.page-1)*e.per_page,l=k>j?"higher":"lower",m={};c=_.filter(i,function(a){var b=parseInt(a.tax_rate_order,10),c=[j,k];return parseInt(a.tax_rate_id,10)===parseInt(h,10)?!0:b>_.min(c)&&b<_.max(c)?!0:"higher"===l&&b===_.max(c)?!0:"lower"===l&&b===_.min(c)?!0:!1}),d=_.map(c,function(a){var b=parseInt(a.tax_rate_order,10);return parseInt(a.tax_rate_id,10)===parseInt(h,10)?a.tax_rate_order=k:"higher"===l?a.tax_rate_order=b-1:"lower"===l&&(a.tax_rate_order=b+1),m[a.tax_rate_id]=_.extend(m[a.tax_rate_id]||{},{tax_rate_order:a.tax_rate_order}),a}),d.length&&(f.logChanges(m),e.render())},sanitizePage:function(a){return a=parseInt(a,10),1>a?a=1:a>this.qty_pages&&(a=this.qty_pages),a}}),n=new l({rates:b.rates}),o=new m({model:n,el:"#rates"});o.render(),g.find(".export").click(function(){var c="data:application/csv;charset=utf-8,"+b.strings.csv_data_cols.join(",")+"\n";return a.each(b.rates,function(a,d){var e="";e+=d.tax_rate_country+",",e+=d.tax_rate_state+",",e+=d.tax_rate_postcode?d.tax_rate_postcode.join("; "):",",e+=d.tax_rate_city?d.tax_rate_city.join("; "):",",e+=d.tax_rate+",",e+=d.tax_rate_name+",",e+=d.tax_rate_priority+",",e+=d.tax_rate_compound+",",e+=d.tax_rate_shipping+",",e+=b.current_class,c+=e+"\n"}),a(this).attr("href",encodeURI(c)),!0})})}(jQuery,htmlSettingsTaxLocalizeScript,wp);